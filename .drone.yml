kind: pipeline

steps:
  - name: build a docker image
    image: docker
    environment:
      DOCKER_IMAGE_NAME:
        from_secret: docker_image_name
    commands:
      - export
      - docker build -t $${DOCKER_IMAGE_NAME} .
    volumes:
      - name: docker_socket
        path: /var/run/docker.sock
  - name: deliverimage
    image: docker
    environment:
      DOCKER_IMAGE_NAME:
        from_secret: docker_image_name
      DOCKER_USERNAME:
        from_secret: docker_username
      DOCKER_PASSWORD:
        from_secret: docker_password
    commands:
      - docker login -u $${DOCKER_USERNAME} -p $${DOCKER_PASSWORD}
      - docker push $${DOCKER_IMAGE_NAME}
      volumes:
        - name: docker_socket
          path: /var/run/docker.sock

volumes:
  - name: docker_socket
    host:
      path: /var/run/docker.sock
